# AI Town FastAPI 后端项目技术报告

## 一、项目背景与目标

AI Town 项目旨在构建一个多智能体自治小镇仿真系统，支持多角色（Agent）基于大语言模型（LLM）进行自主决策、事件生成、记忆管理与互动。系统需具备高可扩展性、易维护性、前后端解耦、支持多模型切换与云端持久化等特性，适用于 AI 社会学、智能体行为建模、AIGC 游戏等场景。

## 二、系统架构设计

### 1. 技术栈

- **后端框架**：FastAPI（Python 3.9+）
- **数据库**：Supabase（PostgreSQL 云服务，RESTful/实时）
- **大模型服务**：OpenAI API、阿里通义千问、DeepSeek、Llama 等多模型灵活切换
- **前端测试**：原生 HTML/JS 测试页，支持全流程 API 调试
- **依赖管理**：requirements.txt

### 2. 目录结构

```
backend/
├── main.py                # FastAPI 应用主入口
├── config.py              # 全局配置（agent、事件生成器、模型等）
├── models.py              # Pydantic 数据结构定义
├── routers/               # 路由层（API接口）
├── services/              # 业务逻辑与数据库操作
├── test.html              # 本地API测试与仿真可视化
├── ...（详见README）
```

### 3. 核心模块说明

- **config.py**：集中管理所有 agent、事件生成器、模型参数，支持热更新与前后端同步。
- **models.py**：定义 Agent、Event、Memory、Relationship 等核心数据结构，保证数据一致性。
- **routers/**：RESTful API 路由，涵盖 agent、event、memory、llm、simulation、websocket 等。
- **services/**：业务逻辑层，封装数据库操作、LLM 调用、仿真主循环等。
- **test.html**：支持事件-全员反应-再事件的自动仿真流程，便于调试和演示。

## 三、关键技术实现

### 1. 多智能体自治与 LLM 决策

- 每个 Agent 拥有独立的 llmPrompts、avatar、性格、职业等设定，支持完全个性化的 LLM 行为驱动。
- 支持多模型（如 qwen-max、deepseek-v3、llama-4 等）灵活切换，模型选择可全局统一或单 agent 独立配置。
- Agent 决策与事件生成均通过 LLMService 统一封装，支持 prompt 拼接、上下文注入、记忆回写等。

### 2. 事件生成与全员反应闭环

- 事件生成器（如"镇长"）可基于全局环境、agent 状态自动生成新事件。
- 前端严格实现"事件-全员反应-再事件"循环，确保每轮事件都被所有 agent 依次响应，保证仿真连贯性。
- 针对云数据库写入延迟，前端每次 agent 反应后增加 5 秒延迟，确保记忆与事件展示一致。

### 3. 记忆系统与可追溯性

- 每个 agent 拥有独立记忆表，支持按 agent_id 查询、分页、类型过滤等。
- 记忆写入与事件、决策强关联，便于行为追溯与分析。

### 4. 云端持久化与前后端解耦

- 所有数据（agent、event、memory）均持久化于 Supabase，支持多端实时同步。
- 前端可直接读取所有 agent、事件生成器的关键信息，实现角色列表、地图渲染、详情弹窗、实时日志等。

### 5. 可扩展性与工程规范

- 所有 API、数据结构、服务层均高度模块化，便于后续扩展新角色、事件类型、经济/政策系统等。
- 支持 WebSocket 实时推送，便于前端实现实时仿真与可视化。
- 配置、模型、仿真主循环均支持热更新与动态调整。

## 四、项目亮点与难点攻关

### 1. 亮点

- **多模型灵活切换**：支持主流 LLM 动态切换，适配不同场景与成本需求。
- **个性化智能体**：每个 agent 支持独立 prompt、模型、avatar，极大提升行为多样性。
- **事件-全员反应闭环**：严格的仿真流程，保证每个事件都被所有 agent 充分响应。
- **云端持久化**：Supabase 云数据库，支持多端同步与数据可追溯。
- **前后端解耦**：API 设计规范，便于多端接入与二次开发。

### 2. 难点与解决方案

- **LLM 决策一致性**：通过 prompt 结构化拼接，确保 agent 行为与设定高度一致。
- **数据库写入延迟**：前端增加延迟与多次刷新，保证数据展示准确。
- **仿真流程同步**：采用严格的事件-全员反应-再事件顺序，避免并发错乱。
- **可扩展性**：所有模块均支持热插拔与动态扩展，适应项目持续演化。

## 五、个人贡献与工程能力体现

- 主导后端架构设计与模块划分，推动多模型、多智能体、事件闭环等核心能力落地。
- 独立实现 LLMService、事件生成、记忆系统、Supabase 持久化等关键模块。
- 优化前端测试页，支持自动仿真、数据可视化与调试，提升开发效率。
- 针对云数据库一致性问题，提出并实现前端延迟与多次刷新机制，显著提升用户体验。
- 编写详细 README 与技术文档，规范团队协作与后续维护。

## 六、总结与展望

本项目已实现多智能体自治、事件驱动、记忆追溯、云端持久化等核心能力，具备良好的可扩展性与工程规范。后续可进一步拓展经济系统、2D/3D 可视化、复杂社会关系建模等，适用于 AI 社会仿真、AIGC 游戏、教育等多元场景。

---

如需英文版、PPT 或更细致的代码讲解，可随时告知！ 